#![no_main]
#![no_std]

mod life;
use embedded_hal::delay::DelayNs;
use life::*;

use embedded_hal::digital::InputPin;
use microbit::hal::{Rng, Timer};
use panic_rtt_target as _;
use rtt_target::{rprintln, rtt_init_print};

use cortex_m_rt::entry;
use microbit::board::Board;
use microbit::display::blocking::Display;

const FRAME_DELAY: u32 = 1000;

enum State {
    Init,
    Running(bool, bool),
    Reset,
    Randomize(bool),
    Compliment(u32, bool),
}

fn get_one_or_zero(rng: &mut Rng) -> u8 {
    rng.random_u8() % 2
}

fn generate_random_board(fb: &mut [[u8; 5]; 5], rng: &mut Rng) {
    for row in fb.iter_mut() {
        for val in row.iter_mut() {
            *val = get_one_or_zero(rng);
        }
    }
}

fn compliment_board(fb: &mut [[u8; 5]; 5]) {
    for row in fb.iter_mut() {
        for val in row.iter_mut() {
            *val ^= 1;
        }
    }
}

#[entry]
fn main() -> ! {
    // Setup Board Stuff
    rtt_init_print!();
    let _board = Board::take().unwrap();
    let mut display = Display::new(_board.display_pins);
    let mut timer = Timer::new(_board.TIMER0);
    let mut rng = Rng::new(_board.RNG);
    let mut button_a = _board.buttons.button_a;
    let mut button_b = _board.buttons.button_b;

    // Setup Program State
    let mut state = State::Init;
    let mut life_grid: [[u8; 5]; 5] = [
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
    ];

    // Main Program Logic
    loop {
        match state {
            State::Init => {
                rprintln!("Init");
                generate_random_board(&mut life_grid, &mut rng);
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Running(button_a.is_low().unwrap(), button_b.is_low().unwrap());
            }
            State::Reset => {
                rprintln!("Reset");
                timer.delay_ms(FRAME_DELAY * 5);
                state = State::Init;
            }
            State::Running(true, _) => {
                rprintln!("Running - Button a pressed");
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Randomize(button_a.is_low().unwrap());
            }
            State::Running(false, true) => {
                rprintln!("Running - Button b pressed");
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Compliment(0, button_b.is_low().unwrap());
            }
            State::Running(false, false) => {
                rprintln!("Running - no buttons pressed");
                life(&mut life_grid);
                display.show(&mut timer, life_grid, FRAME_DELAY);
                if done(&life_grid) {
                    state = State::Reset;
                } else {
                    state = State::Running(button_a.is_low().unwrap(), button_b.is_low().unwrap());
                }
            }
            State::Randomize(true) => {
                rprintln!("Randomize - Button a pressed");
                generate_random_board(&mut life_grid, &mut rng);
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Randomize(button_a.is_low().unwrap());
            }
            State::Randomize(false) => {
                rprintln!("Randomize - no buttons pressed");
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Running(button_a.is_low().unwrap(), button_b.is_low().unwrap());
            }
            State::Compliment(0, true) => {
                rprintln!("Compliment - not ignored and pressed");
                compliment_board(&mut life_grid);
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Compliment(5, button_b.is_low().unwrap())
            }
            State::Compliment(0, false) => {
                rprintln!("Compliment - not ignored and not pressed");
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Running(button_a.is_low().unwrap(), button_b.is_low().unwrap())
            }
            State::Compliment(v, _) => {
                rprintln!("Compliment - ignored and pressed");
                display.show(&mut timer, life_grid, FRAME_DELAY);
                state = State::Compliment(v - 1, button_b.is_low().unwrap())
            }
        };
    }
}
